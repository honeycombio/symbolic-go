version: 2.1
orbs:
  rust: circleci/rust@1.6.1
jobs:
  build_rust_linux_x86_64: &build_rust
    resource_class: medium
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - rust/install:
          version: 1.82.0
      - run: cargo --version
      - run: make symbolic
      - persist_to_workspace:
          root: .
          paths:
            - lib
  build_rust_linux_arm64:
    <<: *build_rust
    resource_class: arm.medium
  build_rust_macos_arm64:
    <<: *build_rust
    resource_class: macos.m1.medium.gen1
    machine: ~
    macos:
      xcode: 16.2.0
  build_go:
    docker:
      - image: cimg/go:1.21.3
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule update --init
      - attach_workspace:
          at: .
      - run: make
  commit_libraries:
    machine:
      image: ubuntu-2204:current
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run: make include/symbolic.h
      - run:
          name: Commit to GitHub
          command: |
            git config user.email "circleci@honeycomb.io"
            git config user.name "CircleCI Bot"
            git add include
            git add lib
            git commit -m "[skip ci] CircleCI commit libraries"
            git push

workflows:
  build:
    jobs:
      - build_rust_linux_x86_64
      - build_rust_linux_arm64
      - build_rust_macos_arm64
      - commit_libraries:
          requires:
            - build_rust_linux_x86_64
            - build_rust_linux_arm64
            - build_rust_macos_arm64
      - build_go:
          requires:
            - build_rust_linux_x86_64
            - build_rust_linux_arm64
            - build_rust_macos_arm64
